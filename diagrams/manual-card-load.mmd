sequenceDiagram
  autonumber
  participant App as Walt App (Android)
  participant Agg as Aggregator / TSP API
  participant TSP as Card Network (VTS / MDES)

  Note over App: Local preflight (no network)
  App->>App: Check NFC/HCE & default wallet
  App->>App: Play Integrity attestation
  App->>App: Collect PAN/expiry/CVC (manual)
  App->>App: Encrypt PAN (Agg SDK or Agg public key)

  %% Eligibility
  App->>Agg: POST /eligibility (encryptedPAN, attestation, device info)
  Agg->>Agg: Validate eligibility, issuer policy, risk checks
  Agg-->>App: {cardRef, status: ELIGIBLE | PENDING_VERIFICATION, methods:[OTP,OOB]}

  %% Step-up verification (if needed)
  alt status == PENDING_VERIFICATION
    App->>Agg: POST /verification/start {cardRef, method}
    Agg->>Agg: Create OTP or OOB challenge with issuer
    Agg-->>App: {verificationSessionId}

    App->>App: User enters OTP or completes OOB
    App->>Agg: POST /verification/confirm {sessionId, code?}
    Agg->>Agg: Validate challenge
    Agg-->>App: {verified:true}
  end

  %% Provisioning
  App->>App: Generate Keystore keypair & attestation
  App->>Agg: POST /provision {cardRef, keyAttestation, walletId/TRID}
  Agg->>TSP: Create device-bound token (DPAN)
  TSP-->>Agg: {tokenRef, maskedDPAN, tokenState}
  Agg-->>App: {tokenRef, maskedDPAN, tokenState}

  App->>App: Store token securely (Keystore / SDK)
  App->>App: UI → “Ready for tap-to-pay”
